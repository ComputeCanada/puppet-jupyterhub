c.JupyterHub.spawner_class = 'slurmformspawner.SlurmFormSpawner'
c.JupyterHub.hub_ip = '0.0.0.0'
c.JupyterHub.ip = '127.0.0.1'
<% if $allow_named_servers { -%>
c.JupyterHub.allow_named_servers = True
c.JupyterHub.named_server_limit_per_user = <%= $named_server_limit_per_user %>
<% } else { -%>
c.JupyterHub.allow_named_servers = False
<% } -%>
c.JupyterHub.ssl_key = '/etc/jupyterhub/ssl/key.pem'
c.JupyterHub.ssl_cert = '/etc/jupyterhub/ssl/cert.pem'

<% if $enable_otp_auth { -%>
c.JupyterHub.authenticator_class = 'pammfauthenticator'
<% } -%>
c.PAMAuthenticator.open_sessions = False
c.PAMAuthenticator.service = "jupyterhub-login"

<% if $admin_groups != undef { -%>
c.JupyterHub.admin_access = True
c.PAMAuthenticator.admin_groups = {<%= join(regsubst($admin_groups, "(.*)", '"\1"'), ", ") %>}
<% } else { -%>
c.JupyterHub.admin_access = False
<% } -%>

c.Spawner.args = ['--KernelSpecManager.ensure_native_kernel=False']

import sys
c.JupyterHub.services = [
<% if $idle_timeout != undef { -%>
    {
        'name': 'cull-idle',
        'admin': True,
        'command': [sys.executable, sys.prefix + '/bin/cull_idle_servers.py', '--timeout=<%= $idle_timeout %>'],
    },
<% } -%>
]

<% if $skip_form { -%>
c.SlurmFormSpawner.skip_form = True
<% } -%>

<% if $form_params['runtime']['min'] != undef { -%>
c.SlurmFormSpawner.runtime_min = <%= $form_params['runtime']['min'] %>
<% } -%>
<% if $form_params['runtime']['def'] != undef { -%>
c.SlurmFormSpawner.runtime_def = <%= $form_params['runtime']['def'] %>
<% } -%>
<% if $form_params['runtime']['max'] != undef { -%>
c.SlurmFormSpawner.runtime_max = <%= $form_params['runtime']['max'] %>
<% } -%>
<% if $form_params['runtime']['step'] != undef { -%>
c.SlurmFormSpawner.runtime_step = <%= $form_params['runtime']['step'] %>
<% } -%>
<% if $form_params['runtime']['lock'] != undef { -%>
c.SlurmFormSpawner.runtime_lock = "<%= $form_params['runtime']['lock'] %>"
<% } -%>
<% if $form_params['mem']['min'] != undef { -%>
c.SlurmFormSpawner.mem_min = <%= $form_params['mem']['min'] %>
<% } -%>
<% if $form_params['mem']['def'] != undef { -%>
c.SlurmFormSpawner.mem_def = <%= $form_params['mem']['def'] %>
<% } -%>
<% if $form_params['mem']['max'] != undef { -%>
c.SlurmFormSpawner.mem_max = <%= $form_params['mem']['max'] %>
<% } -%>
<% if $form_params['mem']['step'] != undef { -%>
c.SlurmFormSpawner.mem_step = <%= $form_params['mem']['step'] %>
<% } -%>
<% if $form_params['mem']['lock'] != undef { -%>
c.SlurmFormSpawner.mem_lock = "<%= $form_params['mem']['lock'] %>"
<% } -%>
<% if $form_params['core']['min'] != undef { -%>
c.SlurmFormSpawner.core_min = <%= $form_params['core']['min'] %>
<% } -%>
<% if $form_params['core']['def'] != undef { -%>
c.SlurmFormSpawner.core_def = <%= $form_params['core']['def'] %>
<% } -%>
<% if $form_params['core']['max'] != undef { -%>
c.SlurmFormSpawner.core_max = <%= $form_params['core']['max'] %>
<% } -%>
<% if $form_params['core']['step'] != undef { -%>
c.SlurmFormSpawner.core_step = <%= $form_params['core']['step'] %>
<% } -%>
<% if $form_params['core']['lock'] != undef { -%>
c.SlurmFormSpawner.core_lock = "<%= $form_params['core']['lock'] %>"
<% } -%>
<% if $form_params['oversubscribe']['def'] != undef { -%>
c.SlurmFormSpawner.oversubscribe_def = "<%= $form_params['oversubscribe']['def'] %>"
<% } -%>
<% if $form_params['oversubscribe']['lock'] != undef { -%>
c.SlurmFormSpawner.oversubscribe_lock = "<%= $form_params['oversubscribe']['lock'] %>"
<% } -%>
<% if $form_params['gpus']['def'] != undef { -%>
c.SlurmFormSpawner.gpus_def = "<%= $form_params['gpus']['def'] %>"
<% } -%>
<% if $form_params['gpus']['choices'] != undef { -%>
c.SlurmFormSpawner.gpus_choices = <%= String($form_params['gpus']['choices']) %>
<% } -%>
<% if $form_params['gpus']['lock'] != undef { -%>
c.SlurmFormSpawner.gpus_lock = "<%= $form_params['gpus']['lock'] %>"
<% } -%>
<% if $form_params['ui']['def'] != undef { -%>
c.SlurmFormSpawner.ui_def = "<%= $form_params['ui']['def'] %>"
<% } -%>
<% if $form_params['ui']['lock'] != undef { -%>
c.SlurmFormSpawner.ui_lock = "<%= $form_params['ui']['lock'] %>"
<% } -%>
